# Bidirectional Network Policy Example
# Demonstrates both ingress and egress rules for a web application tier
#
# This policy allows:
# - Outbound (egress): Web tier can connect to database tier on port 5432
# - Inbound (ingress): Load balancer can connect to web tier on ports 80 and 443

apiVersion: ztap/v1
kind: NetworkPolicy
metadata:
  name: web-tier-bidirectional
spec:
  podSelector:
    matchLabels:
      tier: web
  egress:
    # Allow connections to database tier
    - to:
        podSelector:
          matchLabels:
            tier: database
      ports:
        - protocol: TCP
          port: 5432
    # Allow connections to cache tier
    - to:
        podSelector:
          matchLabels:
            tier: cache
      ports:
        - protocol: TCP
          port: 6379
  ingress:
    # Allow inbound from load balancer
    - from:
        ipBlock:
          cidr: 10.0.0.0/24
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
---
# Database tier policy: Only accept connections from web tier
apiVersion: ztap/v1
kind: NetworkPolicy
metadata:
  name: database-tier-ingress
spec:
  podSelector:
    matchLabels:
      tier: database
  ingress:
    - from:
        podSelector:
          matchLabels:
            tier: web
      ports:
        - protocol: TCP
          port: 5432
---
# API service with IP-based ingress control
apiVersion: ztap/v1
kind: NetworkPolicy
metadata:
  name: api-external-access
spec:
  podSelector:
    matchLabels:
      app: api
  ingress:
    # Allow from corporate network
    - from:
        ipBlock:
          cidr: 192.168.1.0/24
      ports:
        - protocol: TCP
          port: 8080
    # Allow from partner network
    - from:
        ipBlock:
          cidr: 172.16.0.0/16
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow outbound to internal services
    - to:
        ipBlock:
          cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 443
